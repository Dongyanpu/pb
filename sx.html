<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>绍兴售后排班管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --light-bg: #f5f7fa;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --text: #333;
            --text-light: #64748b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 15px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%);
            color: var(--text);
            min-height: 100vh;
            font-size: 16px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(120deg, #1e3a8a 0%, var(--primary) 100%);
            color: white;
            position: relative;
            flex-wrap: wrap;
        }

  .year-selector {
                display: flex;
                align-items: center;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 5px;
                width: 100%;
            }
            
            .mobile-stats {
                display: flex;
                gap: 12px;
                margin-left: auto;
                font-size: 13px;
                background: rgba(255,255,255,0.1);
                padding: 4px 10px;
                border-radius: 20px;
            }
            
            .mobile-stats span {
                display: flex;
                align-items: center;
                gap: 4px;
            }
            
            .system-info {
                display: none;
            }
            
            .year-selector label {
                font-size: 13px;
            }
            
            #yearSelect {
                font-size: 13px;
                padding: 5px 10px;
            }
        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--success), var(--primary), var(--warning));
        }

        .system-title {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }

        .system-title h1 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .system-title h1 i {
            background: rgba(255, 255, 255, 0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .year-selector label {
            font-weight: 500;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 5px;
        }

        #yearSelect {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 6px 12px;
            color: white;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        #yearSelect:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        #yearSelect option {
            background: var(--primary-dark);
            color: white;
        }

        .system-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 15px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
            min-width: 200px;
            width: 100%;
            max-width: 300px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .info-value {
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 20px;
            min-width: 40px;
            text-align: center;
        }

        .content {
            padding: 15px;
        }

        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            background: var(--light-bg);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.03);
        }

        .panel-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }

        .panel-title {
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 15px;
        }

        .date-range {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .date-range input {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            font-size: 14px;
            width: 100%;
            max-width: 150px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            min-height: 42px;
        }

        .btn i {
            font-size: 16px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(34, 197, 94, 0.3);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #ca8a04;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(234, 179, 8, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        .month-tabs {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding: 8px 0;
            margin-bottom: 15px;
            scrollbar-width: thin;
        }

        .month-tabs::-webkit-scrollbar {
            height: 6px;
        }

        .month-tabs::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .month-tabs::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        .tab-button {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            background: #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            min-width: 90px;
            text-align: center;
            font-size: 14px;
        }

        .tab-button:hover {
            background: #cbd5e1;
        }

        .tab-button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .table-container {
            margin-top: 10px;
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.03);
            max-width: 100%;
        }

        .dense-table {
            border-collapse: collapse;
            font-size: 14px;
            min-width: max-content;
            width: 100%;
        }

        .dense-table th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--text-light);
        }

        .fixed-column {
            position: sticky;
            left: 0;
            background: white;
            z-index: 2;
            box-shadow: 2px 0 3px rgba(0, 0, 0, 0.05);
            min-width: 140px;
            padding: 10px 12px;
            font-weight: 500;
        }

        .date-header {
            min-width: 40px;
            padding: 8px 4px;
            background: #f8f9fa;
            border: 1px solid #eee;
            text-align: center;
            font-size: 13px;
        }

        .status-cell {
            min-width: 40px;
            padding: 0;
            border: 1px solid #eee;
            cursor: pointer;
            text-align: center;
            height: 40px;
        }

        .status-dot {
            width: 100%;
            height: 100%;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            transition: all 0.2s;
        }

        .status-dot:hover {
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .status-notes {
            display: flex;
            gap: 20px;
            padding: 15px 20px;
            margin: 20px 0 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #eee;
            flex-wrap: wrap;
            color: #666;
            font-size: 14px;
        }

        .status-note-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .班 { background: #f0f0f0; color: #2e7d32; }
        .值 { background: #f0f0f0; color: #2e7d32; }
        .休 { background: var(--primary); color: white; }
        .假 { background: #fff8e1; color: #f57c00; }

        .status-icon.班 { 
            background: #f0f0f0;
            color: #2e7d32;
            border: 1px solid #d4d4d4;
        }
        .status-icon.值 { 
            background: #f0f0f0;
            color: #2e7d32;
            border: 1px solid #d4d4d4;
        }
        .status-icon.休 { 
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }
        .status-icon.假 { 
            background: #fff8e1;
            color: #f57c00;
            border: 1px solid #ffe082;
        }

        .log-panel {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #eee;
        }

        .log-header {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .log-header h3 {
            font-size: 18px;
            color: var(--primary-dark);
        }

        .log-filter {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: white;
            font-size: 14px;
            min-width: 130px;
        }

        .log-container {
            max-height: 250px;
            overflow-y: auto;
            padding-right: 8px;
            background: white;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--border);
        }

        .log-container::-webkit-scrollbar {
            width: 6px;
        }

        .log-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .log-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        .log-entry {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            display: flex;
            gap: 8px;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: var(--text-light);
            font-size: 12px;
            min-width: 60px;
        }

        .log-message {
            flex: 1;
        }

        .highlight {
            background-color: #fffbe6;
            border-left: 3px solid #faad14;
            padding: 2px 5px;
            border-radius: 0 4px 4px 0;
        }

        .current-day {
            position: relative;
            border: 2px solid var(--primary) !important;
        }

        .current-day::after {
            content: '今';
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--primary);
            color: white;
            font-size: 10px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .name-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .delete-staff-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .delete-staff-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .editable-name {
            outline: none;
            padding: 4px 6px;
            border-radius: 6px;
            transition: all 0.3s;
            min-width: 90px;
            font-size: 14px;
        }

        .editable-name:focus {
            background: #e2e8f0;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .add-staff-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        .add-staff-btn:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 40px;
            margin-bottom: 12px;
            color: #cbd5e1;
        }

        /* 排班弹窗样式 */
        .schedule-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 15px;
        }

        .popup-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: popupFadeIn 0.3s ease-out;
        }

        @keyframes popupFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(120deg, #1e3a8a 0%, var(--primary) 100%);
            color: white;
        }

        .popup-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .popup-body {
            padding: 15px;
            overflow: auto;
            max-height: 70vh;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .schedule-table th {
            background: #f8fafc;
            padding: 10px 6px;
            text-align: center;
            font-weight: 600;
            color: var(--text-light);
            border: 1px solid var(--border);
        }

        .schedule-table td {
            padding: 8px 6px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .schedule-table .status-cell {
            padding: 0;
            height: 40px;
        }

     @media (max-width: 768px) {
            /* 按钮组优化 - 单行排列 */
             .system-info {
        display: none !important;
    }
 .status-notes {
        gap: 10px !important;
        padding: 12px 15px !important;
        font-size: 12px !important;
    }
    
    .status-icon {
        width: 22px !important;
        height: 22px !important;
        font-size: 12px !important;
    }
   .btn-group {
                flex-direction: row !important;
                overflow-x: auto;
                padding-bottom: 5px;
                flex-wrap: nowrap !important;
                scrollbar-width: thin;
            }
            
            .btn-group::-webkit-scrollbar {
                height: 4px;
            }
            
            .btn-group::-webkit-scrollbar-track {
                background: #f1f1f1;
            }
            
            .btn-group::-webkit-scrollbar-thumb {
                background: #c1c1c1;
            }
            
            /* 按钮大小优化 */
            .btn {
                padding: 8px 12px !important;
                font-size: 13px !important;
                min-height: 40px !important;
                min-width: max-content;
                flex-shrink: 0;
            }
                .btn-group .btn {
        flex-shrink: 0 !important;
        min-width: auto !important;
    }
            .btn i {
                font-size: 4px !important;
            }
            
            /* 表格优化 */
            .fixed-column {
                min-width: 90px !important;
                font-size: 13px !important;
                padding: 8px 10px !important;
            }
            
            .editable-name {
                min-width: 70px !important;
                font-size: 13px !important;
                padding: 3px 5px !important;
            }
            
            .date-header, .status-cell {
                min-width: 32px !important;
                height: 32px !important;
                font-size: 12px !important;
            }
            
            .status-dot {
                font-size: 12px !important;
            }
            
            .delete-staff-btn {
                width: 20px !important;
                height: 20px !important;
                font-size: 10px !important;
            }
            
            /* 控制面板优化 */
            .control-panel {
                gap: 12px !important;
                padding: 12px !important;
            }
            
            .panel-section {
                min-width: 100% !important;
            }
            
            .date-range {
                padding: 6px 10px !important;
            }
            
            .date-range input {
                padding: 6px !important;
                font-size: 13px !important;
 max-width: 130px !important;
            }
            

            
            .info-item {
                font-size: 13px !important;
            }
        }
        
        /* 超小屏幕进一步优化 */
        @media (max-width: 480px) {
            .btn {
                padding: 7px 10px !important;
                font-size: 12px !important;
            }
            
            .fixed-column {
                min-width: 80px !important;
            }
            
            .date-header, .status-cell {
                min-width: 28px !important;
                height: 28px !important;
            }
            
            .system-title h1 {
                font-size: 20px !important;
            }
            
            .system-title h1 i {
                width: 32px !important;
                height: 32px !important;
                font-size: 16px
 !important;
            }
	.current-day {
    position: relative;
    border: 2px solid var(--primary) !important;
    background-color: #e6f7ff !important;
    font-weight: bold;
}

/* 添加日期单元格的今日标记 */
.date-header.current-day::after {
    content: '今';
    position: absolute;
    top: 2px;
    right: 2px;
    background: var(--primary);
    color: white;
    font-size: 10px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="system-title">
                <h1><i class="fas fa-calendar-alt"></i> 绍兴售后排班管理系统</h1>
                <div class="year-selector">
                    <label for="yearSelect">选择年份：</label>
                    <select id="yearSelect" class="log-filter"></select>
                    <!-- 移动端统计信息 -->
                    <div class="mobile-stats" id="mobileStats">
                        <span><i class="fas fa-users"></i> <span id="mobileStaffCount">3</span></span>
                        <span><i class="fas fa-calendar-check"></i> <span id="mobileScheduleCount">0</span></span>
                    </div>
                </div>
            </div>

            <div class="system-info">
                <div class="info-item">
                    <span>当前月份：</span>
                    <span class="info-value" id="currentMonthDisplay">六月</span>
                </div>
                <div class="info-item">
                    <span>员工数量：</span>
                    <span class="info-value" id="staffCount">3</span>
                </div>
                <div class="info-item">
                    <span>排班记录：</span>
                    <span class="info-value" id="scheduleCount">0</span>
                </div>
            </div>
        </div>        
        <div class="content">
            <div class="control-panel">
                <div class="panel-section">
                    <div class="panel-title"><i class="fas fa-calendar-day"></i> 日期范围</div>
                    <div class="date-range">
                        <input type="date" id="startDate" class="log-filter">
                        <span>至</span>
                        <input type="date" id="endDate" class="log-filter">
                    </div>
                </div>
                
                <div class="panel-section">
                    <div class="panel-title"><i class="fas fa-tools"></i> 排班操作</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="toggleCustomSchedule()">
                            <i class="fas fa-eye"></i> 查看排班
                        </button>
                        <button class="btn btn-primary" onclick="addStaff()">
                            <i class="fas fa-user-plus"></i> 添加员工
                        </button>
        <button class="btn btn-warning" onclick="goToToday()">
            <i class="fas fa-calendar-day"></i> 返回今日
        </button>
                    </div>
                </div>
                
                <div class="panel-section">
                    <div class="panel-title"><i class="fas fa-history"></i> 记录管理</div>
                    <div class="btn-group">
                        <button class="btn btn-warning" onclick="resetSchedule()">
                            <i class="fas fa-undo"></i> 重置排班
                        </button>
                        <button class="btn btn-danger" onclick="clearLogs()">
                            <i class="fas fa-trash"></i> 清除记录
                        </button>

                    </div>
                </div>
            </div>
            
            <div class="month-tabs" id="monthTabs"></div>
            
            <div id="tablesContainer">
                <div class="empty-state">
                    <i class="fas fa-calendar-check"></i>
                    <h3>排班数据加载中...</h3>
                    <p>请稍候，系统正在初始化排班数据</p>
                </div>
            </div>
            
            <div class="status-notes">
                <div class="status-note-item">
                    <span class="status-icon 班">班</span>
                    <span>当日 8:30 - 17:30</span>
                </div>
                <div class="status-note-item">
                    <span class="status-icon 值">值</span>
                    <span>当日 8:30 - 次日 8:30</span>
                </div>
                <div class="status-note-item">
                    <span class="status-icon 休">休</span>
                    <span>当日休息</span>
                </div>
                <div class="status-note-item">
                    <span class="status-icon 假">假</span>
                    <span>当日请假</span>
                </div>
            </div>
            
            <div class="log-panel">
                <div class="log-header">
                    <h3><i class="fas fa-clipboard-list"></i> 操作记录</h3>
                    <select id="logFilter" class="log-filter">
                        <option value="all">全部记录</option>
                        <option value="→ 休">休息变更</option>
                        <option value="→ 假">休假变更</option>
                        <option value="删除人员">删除记录</option>
                    </select>
                </div>
                <div class="log-container" id="logEntries">
                    <div class="log-entry">
                        <div class="log-time">10:30</div>
                        <div class="log-message">系统初始化完成，排班管理已就绪</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 状态管理
       const state = {
            year: new Date().getFullYear(),
            staff: ['董彦普', '张昭', '孙新'],
            schedule: {},
            logs: [
                { time: new Date().toLocaleTimeString(), message: "系统初始化完成，排班管理已就绪" }
            ],
            activeMonth: new Date().toLocaleString('zh-CN', { year: 'numeric', month: '2-digit' }).replace('/', '-')
        };

        // 初始化系统
        function initSystem() {
            // 尝试从localStorage加载数据
            const savedYear = localStorage.getItem('year');
            const savedStaff = localStorage.getItem('staff');
            const savedSchedule = localStorage.getItem('schedule');
            const savedLogs = localStorage.getItem('logs');
            const savedActiveMonth = localStorage.getItem('activeMonth');
            
            if (savedYear) state.year = parseInt(savedYear);
            if (savedStaff) state.staff = JSON.parse(savedStaff);
            if (savedSchedule) state.schedule = JSON.parse(savedSchedule);
            if (savedLogs) state.logs = JSON.parse(savedLogs);
            if (savedActiveMonth) state.activeMonth = savedActiveMonth;
            
            // 初始化年份选择器
            initYearSelector();
            
            // 生成月份标签
            generateMonthTabs();
            
            // 渲染所有表格
            renderAllTables();
            
            // 更新统计信息
            updateStats();
            
            // 激活当前月份标签
            activateTab(state.activeMonth);
            
            // 更新当前月份显示
            updateCurrentMonthDisplay();
            
            // 绑定事件监听器
            document.getElementById('logFilter').addEventListener('change', refreshLogs);
            document.addEventListener('input', handleNameEdit);
            document.getElementById('yearSelect').addEventListener('change', changeYear);
            
            // 设置默认日期范围
            setupDefaultDates();
            
            // 刷新日志
            refreshLogs();
    
  setupDefaultDates();
    const today = new Date();
    const currentMonthKey = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
    
    // 如果当前月份标签存在，则激活它
    if (document.querySelector(`.tab-button[data-month="${currentMonthKey}"]`)) {
        activateTab(currentMonthKey);
        
        // 添加日志
        addLog(`自动跳转到当前月份: ${currentMonthKey}`);
    }
    
    // 添加自动滚动到当前日期功能
    setTimeout(() => {
        const todayCell = document.querySelector(`.current-day`);
        if (todayCell) {
            todayCell.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest', 
                inline: 'center' 
            });
        }
    }, 300);
}
function setupDefaultDates() {
    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
    const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('startDate').valueAsDate = startDate;
    document.getElementById('endDate').valueAsDate = endDate;
}
        // 更新当前月份显示
        function updateCurrentMonthDisplay() {
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', 
                                '七月', '八月', '九月', '十月', '十一月', '十二月'];
            const monthNum = parseInt(state.activeMonth.split('-')[1]);
            document.getElementById('currentMonthDisplay').textContent = monthNames[monthNum - 1];
        }

        // 设置默认日期范围
        function setupDefaultDates() {
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
        }

        // 初始化年份选择器
        function initYearSelector() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            
            // 清空现有选项
            yearSelect.innerHTML = '';
            
            // 添加最近5年的选项
            for (let year = currentYear - 2; year <= currentYear + 3; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + '年';
                if (year === state.year) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // 处理年份变更
        function changeYear(event) {
            const newYear = parseInt(event.target.value);
            if (state.year !== newYear) {
                state.year = newYear;
                localStorage.setItem('year', newYear.toString());
                
                // 重新生成月份标签和表格
                generateMonthTabs();
                renderAllTables();
                
                // 激活第一个月份标签
                activateTab(`${state.year}-01`);
                
                // 记录日志
                addLog(`年份切换为 ${newYear}`);
            }
        }

    function generateMonthTabs() {
        const monthTabs = document.getElementById('monthTabs');
        monthTabs.innerHTML = '';
        
        // 获取当前活跃月份信息
        const [activeYear, activeMonth] = state.activeMonth.split('-').map(Number);
        
        // 确定要显示的月份范围
        let monthsToShow = [];
        if (isMobile()) {
            // 移动端只显示当前月及前后各一个月
            monthsToShow = [
                {month: activeMonth - 1, year: activeYear},
                {month: activeMonth, year: activeYear},
                {month: activeMonth + 1, year: activeYear}
            ];
            
            // 处理跨年情况
            monthsToShow = monthsToShow.map(m => {
                if (m.month === 0) return {month: 12, year: m.year - 1};
                if (m.month === 13) return {month: 1, year: m.year + 1};
                return m;
            }).filter(m => m.month >= 1 && m.month <= 12);
        } else {
            // 桌面端显示所有月份
            for (let month = 1; month <= 12; month++) {
                monthsToShow.push({month, year: activeYear});
            }
        }
        
        // 生成月份标签
        monthsToShow.forEach(({month, year}) => {
            const monthName = month < 10 ? `0${month}` : month;
            const monthKey = `${year}-${monthName}`;
            const monthLabel = `${year}年${month}月`;
            
            const tab = document.createElement('button');
            tab.className = 'tab-button';
            tab.textContent = monthLabel;
            tab.dataset.month = monthKey;
            
            if (state.activeMonth === monthKey) {
                tab.classList.add('active');
            }
            
            tab.addEventListener('click', () => {
                activateTab(monthKey);
                addLog(`切换到${monthLabel}`);
                
                // 移动端点击后重新生成月份标签
                if (isMobile()) {
                    generateMonthTabs();
                }
            });
            
            monthTabs.appendChild(tab);
        });
    }

 function activateTab(monthKey) {
        state.activeMonth = monthKey;
        localStorage.setItem('activeMonth', monthKey);
        
        // 更新活跃状态
        document.querySelectorAll('.tab-button').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.month === monthKey);
        });
        
        // 显示对应月份的表格
        document.querySelectorAll('.table-container').forEach(table => {
            table.style.display = table.dataset.month === monthKey ? 'block' : 'none';
        });
        
        // 更新当前月份显示
        updateCurrentMonthDisplay();
    }

    // 在窗口大小改变时重新生成月份标签
    window.addEventListener('resize', function() {
        generateMonthTabs();
    });

        // 渲染所有月份的表格
        function renderAllTables() {
            const tablesContainer = document.getElementById('tablesContainer');
            tablesContainer.innerHTML = '';
            
            for (let month = 1; month <= 12; month++) {
                const monthName = month < 10 ? `0${month}` : month;
                const monthKey = `${state.year}-${monthName}`;
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'table-container';
                tableContainer.dataset.month = monthKey;
                tableContainer.style.display = monthKey === state.activeMonth ? 'block' : 'none';
                
                const table = createMonthTable(month);
                tableContainer.appendChild(table);
                
                tablesContainer.appendChild(tableContainer);
            }
        }

        // 创建月份表格
        function createMonthTable(month) {
            // 获取该月份的第一天和最后一天
            const firstDay = new Date(state.year, month - 1, 1);
            const lastDay = new Date(state.year, month, 0);
            
            // 创建表格
            const table = document.createElement('table');
            table.className = 'dense-table';
            
            // 创建表头（星期行）
            const headerRow = document.createElement('tr');
            
            // 添加员工名字列头
            const nameHeader = document.createElement('th');
            nameHeader.className = 'fixed-column';
            nameHeader.textContent = '员工';
            headerRow.appendChild(nameHeader);
            
            // 添加日期列
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(state.year, month - 1, day);
                
                const th = document.createElement('th');
                th.className = 'date-header';
                th.textContent = `${day}`;
                
                // 标记为今天
                const today = new Date();
                if (today.getFullYear() === state.year && 
                    today.getMonth() + 1 === month && 
                    today.getDate() === day) {
                    th.classList.add('current-day');
                }
                
                th.innerHTML += `<div>${getWeekday(date)}</div>`;
                headerRow.appendChild(th);
            }
            
            table.appendChild(headerRow);
            
            // 为每个员工创建一行
            state.staff.forEach((staff, staffIndex) => {
                const row = document.createElement('tr');
                
                // 员工名字列
                const nameCell = document.createElement('td');
                nameCell.className = 'fixed-column';
                
                const nameContainer = document.createElement('div');
                nameContainer.className = 'name-container';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'editable-name';
                nameSpan.textContent = staff;
                nameSpan.dataset.original = staff;
                nameSpan.contentEditable = true;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-staff-btn';
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.title = "删除员工";
                deleteBtn.addEventListener('click', () => deleteStaff(staffIndex));
                
                nameContainer.appendChild(nameSpan);
                // 防止删除自己的按钮
                if (staffIndex > 0) {
                    nameContainer.appendChild(deleteBtn);
                }
                
                nameCell.appendChild(nameContainer);
                row.appendChild(nameCell);
                
                // 为每一天创建单元格
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dateStr = `${state.year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    
                    // 初始化状态（工作日）
                    let status = '班';
                    
                    // 检查是否已存在排班数据
                    if (state.schedule[staff] && state.schedule[staff][dateStr]) {
                        status = state.schedule[staff][dateStr];
                    }
                    
                    const cell = createStatusCell(dateStr, staff, status);
                    row.appendChild(cell);
                }
                
                table.appendChild(row);
            });
            
            // 添加新员工行

            
            return table;
        }

        // 创建状态单元格
        function createStatusCell(date, staff, status) {
            const cell = document.createElement('td');
            cell.className = 'status-cell';
            cell.dataset.date = date;
            cell.dataset.staff = staff;
            
            const dot = document.createElement('div');
            dot.className = `status-dot ${status}`;
            dot.textContent = status;
            dot.onclick = () => toggleStatus(cell);
            
            cell.appendChild(dot);
            return cell;
        }

        // 切换状态
        function toggleStatus(cell) {
            const staff = cell.dataset.staff;
            const date = cell.dataset.date;
            const currentStatus = cell.querySelector('.status-dot').textContent;
            
            const statusMap = {
                '班': '值',
                '值': '休',
                '休': '假',
                '假': '班'
            };
            
            const newStatus = statusMap[currentStatus];
            const dot = cell.querySelector('.status-dot');
            dot.textContent = newStatus;
            dot.className = `status-dot ${newStatus}`;
            
            // 保存到状态管理
            if (!state.schedule[staff]) {
                state.schedule[staff] = {};
            }
            state.schedule[staff][date] = newStatus;
            
            // 保存到localStorage
            localStorage.setItem('schedule', JSON.stringify(state.schedule));
            
            // 记录日志
            addLog(`员工 ${staff} ${date} 状态由 ${currentStatus} 改为 ${newStatus}`);
            
            // 更新统计数据
            updateStats();
        }

        // 更新统计数据
        function updateStats() {
            // 更新员工数量
 const staffCount = state.staff.length;
            document.getElementById('staffCount').textContent = staffCount;
            document.getElementById('mobileStaffCount').textContent = staffCount;
            
            // 计算排班记录数量
            let scheduleCount = 0;
            for (const staff in state.schedule) {
                scheduleCount += Object.keys(state.schedule[staff]).length;
            }
            document.getElementById('scheduleCount').textContent = scheduleCount;
            document.getElementById('mobileScheduleCount').textContent = scheduleCount;
            
            localStorage.setItem('staff', JSON.stringify(state.staff));
        }
 document.addEventListener('DOMContentLoaded', initSystem);

        // 添加日志
        function addLog(message) {
            const now = new Date();
            const time = now.toLocaleTimeString();
            
            state.logs.unshift({
                time: time,
                message: message
            });
            
            // 仅保留最近的50条日志
            if (state.logs.length > 50) {
                state.logs.pop();
            }
            
            localStorage.setItem('logs', JSON.stringify(state.logs));
            refreshLogs();
        }

        // 刷新日志显示
        function refreshLogs() {
            const logContainer = document.getElementById('logEntries');
            const filterType = document.getElementById('logFilter').value;
            logContainer.innerHTML = '';
            
            const filteredLogs = state.logs.filter(log => {
                if (filterType === 'all') return true;
                if (filterType === '→ 休') return log.message.includes('→ 休');
                if (filterType === '→ 假') return log.message.includes('→ 假');
                if (filterType === '删除人员') return log.message.includes('删除');
                return false;
            });
            
            filteredLogs.forEach(log => {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                
                const timeSpan = document.createElement('div');
                timeSpan.className = 'log-time';
                timeSpan.textContent = log.time;
                
                const messageSpan = document.createElement('div');
                messageSpan.className = 'log-message';
                messageSpan.textContent = log.message;
                
                if (log.message.includes('删除')) {
                    messageSpan.classList.add('highlight');
                }
                
                entry.appendChild(timeSpan);
                entry.appendChild(messageSpan);
                logContainer.appendChild(entry);
            });
        }

        // 处理名字编辑
        function handleNameEdit(event) {
            if (event.target.classList.contains('editable-name')) {
                const original = event.target.dataset.original;
                const newName = event.target.textContent.trim();
                
                if (newName && newName !== original) {
                    const index = state.staff.indexOf(original);
                    if (index !== -1) {
                        // 更新状态管理
                        state.staff[index] = newName;
                        
                        // 保存到localStorage
                        localStorage.setItem('staff', JSON.stringify(state.staff));
                        
                        // 更新日志
                        addLog(`员工更名：${original} → ${newName}`);
                        
                        // 更新统计数据
                        updateStats();
                        
                        // 重置原始记录
                        event.target.dataset.original = newName;
                    }
                }
            }
        }

function addStaff() {
    const newStaffName = prompt('请输入新员工的姓名：');
    if (newStaffName && newStaffName.trim() !== '') {
        const trimmedName = newStaffName.trim();
        state.staff.push(trimmedName);
        
        // 保存到localStorage
        localStorage.setItem('staff', JSON.stringify(state.staff));
        
        // 重新渲染表格
        renderAllTables();
        activateTab(state.activeMonth);
        
        // 添加日志
        addLog(`添加新员工：${trimmedName}`);
        
        // 更新统计数据
        updateStats();
        
        // 滚动到新员工
        setTimeout(() => {
            const newStaffRows = document.querySelectorAll('.fixed-column');
            if (newStaffRows.length > 0) {
                const lastStaffRow = newStaffRows[newStaffRows.length - 1];
                lastStaffRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }, 300);
    }
}
        // 删除员工
        function deleteStaff(staffIndex) {
            const staffName = state.staff[staffIndex];
            if (confirm(`确定要删除员工 ${staffName} 吗？`)) {
                state.staff.splice(staffIndex, 1);
                
                // 保存到localStorage
                localStorage.setItem('staff', JSON.stringify(state.staff));
                
                // 重新渲染表格
                renderAllTables();
                activateTab(state.activeMonth);
                
                // 添加日志
                addLog(`删除员工：${staffName}`);
                
                // 更新统计数据
                updateStats();
            }
        }

        // 重置排班
function resetSchedule() {
    if (confirm('确定要重置所有排班记录吗？')) {
        state.schedule = {};
        localStorage.setItem('schedule', JSON.stringify(state.schedule));
        
        // 重新渲染表格
        renderAllTables();
        activateTab(state.activeMonth);
        
        // 添加日志
        addLog('所有排班已重置');
        
        // 更新统计数据
        updateStats();
        
        // 显示成功提示
        alert('排班已成功重置！');
    }
}
function clearLogs() {
    if (confirm('确定要清除所有操作记录吗？')) {
        state.logs = [];
        localStorage.setItem('logs', JSON.stringify(state.logs));
        refreshLogs();
        
        // 添加一条初始日志
        state.logs.push({
            time: new Date().toLocaleTimeString(), 
            message: "操作记录已清空"
        });
        refreshLogs();
    }
}


        // 获取星期几
        function getWeekday(date) {
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            return weekdays[date.getDay()];
        }
// 查看排班功能
function toggleCustomSchedule() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert('请选择日期范围');
        return;
    }
    
    // 创建弹窗显示排班信息
    createSchedulePopup(startDate, endDate);
    addLog(`查看排班: ${startDate} 至 ${endDate}`);
}

// 创建排班弹窗
function createSchedulePopup(startDate, endDate) {
    // 移除现有弹窗
    const existingPopup = document.getElementById('schedulePopup');
    if (existingPopup) existingPopup.remove();
    
    // 创建弹窗元素
    const popup = document.createElement('div');
    popup.id = 'schedulePopup';
    popup.className = 'schedule-popup';
    
    // 弹窗内容
    popup.innerHTML = `
        <div class="popup-content">
            <div class="popup-header">
                <h3>${startDate} 至 ${endDate} 排班详情</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="popup-body" id="popupScheduleTable"></div>
        </div>
    `;
    
    document.body.appendChild(popup);
    
    // 关闭按钮事件
    popup.querySelector('.close-btn').addEventListener('click', () => {
        popup.remove();
    });
    
    // 生成排班表格
    generateScheduleTable(startDate, endDate);
}

// 生成排班表格
function generateScheduleTable(startDate, endDate) {
    const tableContainer = document.getElementById('popupScheduleTable');
    tableContainer.innerHTML = '';
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    // 计算日期范围
    const dateRange = [];
    let currentDate = new Date(start);
    while (currentDate <= end) {
        dateRange.push(new Date(currentDate));
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    // 创建表格
    const table = document.createElement('table');
    table.className = 'schedule-table';
    
    // 创建表头
    const headerRow = document.createElement('tr');
    const nameHeader = document.createElement('th');
    nameHeader.textContent = '员工';
    headerRow.appendChild(nameHeader);
    
    dateRange.forEach(date => {
        const dateHeader = document.createElement('th');
        dateHeader.textContent = `${date.getMonth() + 1}/${date.getDate()}`;
        dateHeader.innerHTML += `<div>${getWeekday(date)}</div>`;
        
        // 标记今天
        const today = new Date();
        if (date.toDateString() === today.toDateString()) {
            dateHeader.classList.add('current-day');
        }
        
        headerRow.appendChild(dateHeader);
    });
    table.appendChild(headerRow);
    
    // 添加员工排班行
    state.staff.forEach(staff => {
        const row = document.createElement('tr');
        
        const nameCell = document.createElement('td');
        nameCell.textContent = staff;
        row.appendChild(nameCell);
        
        dateRange.forEach(date => {
            const dateStr = formatDate(date);
            const statusCell = document.createElement('td');
            statusCell.className = 'status-cell';
            
            let status = '班';
            if (state.schedule[staff] && state.schedule[staff][dateStr]) {
                status = state.schedule[staff][dateStr];
            }
            
            const dot = document.createElement('div');
            dot.className = `status-dot ${status}`;
            dot.textContent = status;
            statusCell.appendChild(dot);
            
            row.appendChild(statusCell);
        });
        
        table.appendChild(row);
    });
    
    tableContainer.appendChild(table);
}
function goToToday() {
    const today = new Date();
    const currentMonthKey = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
    
    // 激活当前月份标签
    activateTab(currentMonthKey);
    
    // 滚动到当前日期
    setTimeout(() => {
        const todayCell = document.querySelector(`.current-day`);
        if (todayCell) {
            todayCell.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest', 
                inline: 'center' 
            });
        }
    }, 300);
    
    // 添加日志
    addLog(`已返回今日`);
}
    function isMobile() {
        return window.innerWidth <= 768;
    }
// 格式化日期为 YYYY-MM-DD
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}
        // 页面加载完成后初始化系统
        document.addEventListener('DOMContentLoaded', initSystem);
    </script>
</body>
</html>
