<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>绍兴售后排班管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light-bg: #f8fafc;
            --card-bg: #fff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--light-bg);
            color: var(--text);
            min-height: 100vh;
            font-size: 15px;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            padding-bottom: 20px;
            transition: all 0.3s ease;
        }

        .header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 24px 20px 16px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        .system-title {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 12px;
        }

        .system-title h1 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .system-title h1 i {
            background: rgba(255,255,255,0.2);
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .system-title h1 i:hover {
            transform: scale(1.05);
            background: rgba(255,255,255,0.25);
        }

        .control-panel {
            display: flex;
            gap: 20px;
            padding: 20px;
            border-radius: 16px;
            margin: 20px;
            background: var(--light-bg);
            box-shadow: var(--shadow);
        }

        .panel-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-range {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .date-range label {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text);
        }

        .date-range label i {
            font-size: 16px;
            color: var(--primary);
        }

        .date-range input {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .date-range input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            min-height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn i {
            font-size: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .month-tabs {
            display: flex;
            gap: 4px;
            padding: 0 20px;
            margin-bottom: 16px;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }

        .month-tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-button {
            padding: 8px 16px;
            border: none;
            border-radius: 10px;
            background: var(--light-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
            font-size: 14px;
            color: var(--text-light);
            white-space: nowrap;
        }

        .tab-button:hover {
            background: #e2e8f0;
            color: var(--text);
        }

        .tab-button.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .table-container {
            padding: 0 20px;
            margin-bottom: 20px;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .table-container::-webkit-scrollbar {
            height: 6px;
        }

        .table-container::-webkit-scrollbar-track {
            background: var(--light-bg);
            border-radius: 3px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .dense-table {
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            width: 100%;
            min-width: max-content;
        }

        .dense-table th, .dense-table td {
            padding: 8px 4px;
        }

        .fixed-column {
            position: sticky;
            left: 0;
            background: var(--card-bg);
            z-index: 2;
            min-width: 120px;
            padding: 8px 12px;
            font-weight: 600;
            text-align: left;
            border-radius: 8px 0 0 8px;
            box-shadow: 4px 0 8px rgba(0, 0, 0, 0.05);
        }

        .dense-table tr:hover {
            background: var(--light-bg);
        }

        .date-header {
            min-width: 60px;
            padding: 12px 4px;
            background: var(--light-bg);
            border: none;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .date-header.current-day, .current-day {
            background: var(--primary) !important;
            color: white !important;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        .status-cell {
            min-width: 50px;
            padding: 4px;
            border: none;
            cursor: pointer;
            text-align: center;
            height: 50px;
            transition: all 0.2s ease;
        }

        .status-cell:hover {
            background: var(--light-bg);
        }

        .status-dot {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .status-dot.班 { background: #e0f2fe; color: #0284c7; }
        .status-dot.值 { background: #e0f2fe; color: #0284c7; }
        .status-dot.休 { background: var(--primary); color: white; }
        .status-dot.假 { background: #fef3c7; color: #d97706; }

        .status-dot:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow);
        }

        .status-notes {
            display: flex;
            gap: 16px;
            padding: 16px 20px;
            margin: 0 20px 20px;
            border-radius: 12px;
            background: var(--light-bg);
            box-shadow: var(--shadow);
        }

        .status-note-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: var(--text);
        }

        .status-icon {
            width: 24px;
            height: 24px;
            font-size: 14px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .status-icon.班 { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; }
        .status-icon.值 { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; }
        .status-icon.休 { background: var(--primary); color: white; border: 1px solid var(--primary); }
        .status-icon.假 { background: #fef3c7; color: #d97706; border: 1px solid #fcd34d; }

        .log-panel {
            margin: 0 20px;
            padding: 20px;
            border-radius: 12px;
            background: var(--light-bg);
            box-shadow: var(--shadow);
        }

        .log-header {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .log-header h3 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .log-filter {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: white;
            min-width: 120px;
            transition: all 0.2s ease;
        }

        .log-filter:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .log-container {
            max-height: 200px;
            padding: 8px;
            border-radius: 8px;
            background: white;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        .log-container::-webkit-scrollbar {
            width: 6px;
        }

        .log-container::-webkit-scrollbar-track {
            background: var(--light-bg);
            border-radius: 3px;
        }

        .log-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .log-entry {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .log-entry:hover {
            background: var(--light-bg);
        }

        .log-time {
            font-size: 12px;
            color: var(--text-light);
            min-width: 50px;
        }

        .log-message {
            flex: 1;
        }

        .highlight {
            background-color: #fef3c7;
            border-left: 3px solid #f59e0b;
            padding: 4px 8px;
            border-radius: 0 4px 4px 0;
        }

        .name-container {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .delete-staff-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .delete-staff-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .editable-name {
            outline: none;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            min-width: 80px;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .editable-name:focus {
            background: #e0e7ff;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .add-staff-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            box-shadow: var(--shadow);
        }

        .add-staff-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--primary);
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        .empty-state p {
            font-size: 14px;
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .container {
                border-radius: 12px;
                margin: 0;
            }

            .header {
                padding: 12px 8px;
                border-radius: 0 0 12px 12px;
            }

            .system-title h1 {
                font-size: 16px;
                gap: 8px;
            }

            .system-title h1 i {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .control-panel {
                flex-direction: column;
                gap: 12px;
                padding: 12px;
                margin: 12px;
                border-radius: 12px;
            }

            .panel-section {
                width: 100%;
            }

            .panel-title {
                font-size: 14px;
            }

            .date-range {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                padding: 12px;
            }

            .date-range label {
                font-size: 0;
                justify-content: center;
            }

            .date-range label i {
                font-size: 18px;
            }

            .date-range input {
                width: 100%;
                padding: 8px;
                font-size: 14px;
            }

            .btn-group {
                gap: 6px;
                flex-wrap: wrap;
            }

            .btn {
                flex: 1;
                min-width: 120px;
                padding: 8px 12px;
                font-size: 13px;
                min-height: 36px;
                justify-content: center;
            }

            .btn i {
                font-size: 14px;
            }

            .month-tabs {
                padding: 0 12px;
                margin-bottom: 12px;
                gap: 4px;
                justify-content: flex-start;
            }

            .tab-button {
                padding: 6px 10px;
                font-size: 12px;
                min-width: 50px;
            }

            .table-container {
                padding: 0 12px;
                margin-bottom: 12px;
            }

            .dense-table th, .dense-table td {
                font-size: 12px;
                padding: 4px 2px;
            }

            .fixed-column {
                min-width: 80px;
                padding: 4px 6px;
                font-size: 12px;
            }

            .status-cell {
                min-width: 36px;
                height: 36px;
            }

            .status-dot {
                font-size: 12px;
                border-radius: 6px;
            }

            .status-notes {
                flex-direction: column;
                gap: 8px;
                padding: 12px;
                margin: 0 12px 12px;
            }

            .status-note-item {
                font-size: 12px;
                gap: 8px;
            }

            .status-icon {
                width: 20px;
                height: 20px;
                font-size: 12px;
            }

            .log-panel {
                margin: 0 12px;
                padding: 12px;
            }

            .log-header {
                gap: 8px;
                margin-bottom: 8px;
            }

            .log-header h3 {
                font-size: 14px;
            }

            .log-filter {
                padding: 6px 8px;
                font-size: 12px;
                min-width: 90px;
            }

            .log-container {
                max-height: 120px;
            }

            .log-entry {
                padding: 4px 6px;
                font-size: 12px;
            }

            .log-time {
                font-size: 11px;
                min-width: 36px;
            }

            .editable-name {
                font-size: 12px;
                padding: 3px 6px;
            }

            .delete-staff-btn {
                width: 20px;
                height: 20px;
                font-size: 11px;
            }
        }

        @media (min-width: 769px) {
            .control-panel {
                display: flex;
                flex-direction: row;
                align-items: flex-start;
            }

            .panel-section {
                flex: 1;
            }

            .panel-section:first-child {
                flex: 2;
            }

            .date-range {
                flex-wrap: nowrap;
            }

            .date-range input {
                flex: 1;
            }

            .btn-group {
                justify-content: flex-start;
            }

            .log-header {
                justify-content: space-between;
            }

            .log-container {
                max-height: 200px;
            }
        }

        /* 排班弹窗样式 */
        .schedule-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .schedule-popup.active {
            opacity: 1;
            visibility: visible;
        }

        .popup-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .schedule-popup.active .popup-content {
            transform: translateY(0);
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .popup-header h3 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .popup-body {
            padding: 20px;
            overflow: auto;
            max-height: calc(90vh - 70px);
        }

        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            min-width: max-content;
        }

        .schedule-table th, .schedule-table td {
            padding: 8px 4px;
        }

        .schedule-table th {
            background: var(--light-bg);
            text-align: center;
            font-weight: 600;
            color: var(--text-light);
            border: none;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .schedule-table td {
            text-align: center;
            border: none;
        }

        .schedule-table .fixed-column {
            position: sticky;
            left: 0;
            background: var(--card-bg);
            z-index: 3;
            min-width: 120px;
            padding: 8px 12px;
            font-weight: 600;
            text-align: left;
            border-radius: 8px 0 0 8px;
            box-shadow: 4px 0 8px rgba(0, 0, 0, 0.05);
        }

        .schedule-table tr:hover {
            background: var(--light-bg);
        }

        /* 移动端刷新按钮样式 */
        .refresh-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .refresh-btn i {
            font-size: 20px;
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            .refresh-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .schedule-popup {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="system-title">
                <h1>绍兴售后排班管理系统</h1>
            </div>        
        </div>        
        <div class="content">
            <div class="control-panel">
                <div class="panel-section" style="flex-direction: row; align-items: center; gap: 12px;">
                    <label for="startDate"><i class="fas fa-calendar-day"></i></label>
                    <input type="date" id="startDate">
                    <span style="margin: 0 4px;">至</span>
                    <input type="date" id="endDate">
                </div>
                
                <div class="panel-section">
                    <div class="panel-title"><i class="fas fa-tools"></i> 排班操作</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="toggleCustomSchedule()">
                            <i class="fas fa-eye"></i> 查看排班
                        </button>
                        <button class="btn btn-primary" onclick="addStaff()">
                            <i class="fas fa-user-plus"></i> 添加员工
                        </button>
                        <button class="btn btn-success" onclick="autoArrange231()">
                            <i class="fas fa-magic"></i> 自动生成上二休一
                        </button>
                        <button class="btn btn-warning" onclick="goToToday()">
                            <i class="fas fa-calendar-day"></i> 返回今日
                        </button>
                        <button class="btn btn-warning" onclick="resetSchedule()">
                            <i class="fas fa-undo"></i> 重置排班
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="month-tabs" id="monthTabs"></div>
            
            <div id="tablesContainer">
                <div class="empty-state">
                    <i class="fas fa-calendar-check"></i>
                    <h3>排班数据加载中...</h3>
                    <p>请稍候，系统正在初始化排班数据</p>
                </div>
            </div>
            
            <div class="status-notes">
                <div class="status-note-item">
                    <span class="status-icon 班">班</span>
                    <span>当日 8:30 - 17:30</span>
                </div>
                <div class="status-note-item">
                    <span class="status-icon 值">值</span>
                    <span>当日 8:30 - 次日 8:30</span>
                </div>
                <div class="status-note-item">
                    <span class="status-icon 休">休</span>
                    <span>当日休息</span>
                </div>
                <div class="status-note-item">
                    <span class="status-icon 假">假</span>
                    <span>当日请假</span>
                </div>
            </div>
            
            <div class="log-panel">
                <div class="log-header">
                    <h3><i class="fas fa-clipboard-list"></i> 操作记录</h3>
                    <select id="logFilter" class="log-filter">
                        <option value="all">全部记录</option>
                        <option value="→ 休">休息变更</option>
                        <option value="→ 假">休假变更</option>
                        <option value="删除人员">删除记录</option>
                    </select>
                    <button class="btn btn-danger" onclick="clearLogs()">
                        <i class="fas fa-trash"></i> 清除记录
                    </button>
                </div>
                <div class="log-container" id="logEntries">
                    <div class="log-entry">
                        <div class="log-time">10:30</div>
                        <div class="log-message">系统初始化完成，排班管理已就绪</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 排班查看弹窗 -->
    <div class="schedule-popup" id="schedulePopup">
        <div class="popup-content">
            <div class="popup-header">
                <h3><i class="fas fa-calendar-alt"></i> 排班查看</h3>
                <button class="close-btn" onclick="toggleCustomSchedule()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="popup-body" id="schedulePopupBody">
                <!-- 弹窗内容将通过 JavaScript 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 移动端刷新按钮 -->
    <button class="refresh-btn" onclick="refreshAll()" title="刷新">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script>
        // 状态管理
       const state = {
            year: new Date().getFullYear(),
            staff: ['董彦普', '张昭', '孙新'],
            schedule: {},
            logs: [
                { time: new Date().toLocaleTimeString(), message: "系统初始化完成，排班管理已就绪" }
            ],
            activeMonth: new Date().toLocaleString('zh-CN', { year: 'numeric', month: '2-digit' }).replace('/', '-')
        };

        // 初始化系统
        function initSystem() {
            // 尝试从localStorage加载数据
            const savedStaff = localStorage.getItem('staff');
            const savedSchedule = localStorage.getItem('schedule');
            const savedLogs = localStorage.getItem('logs');
            const savedActiveMonth = localStorage.getItem('activeMonth');
            
            if (savedStaff) state.staff = JSON.parse(savedStaff);
            if (savedSchedule) state.schedule = JSON.parse(savedSchedule);
            if (savedLogs) state.logs = JSON.parse(savedLogs);
            if (savedActiveMonth) state.activeMonth = savedActiveMonth;
            
            // 生成月份标签
            generateMonthTabs();
            
            // 渲染所有表格
            renderAllTables();
            
            // 激活当前月份标签
            activateTab(state.activeMonth);
            
            // 更新当前月份显示
            updateCurrentMonthDisplay();
            
            // 绑定事件监听器
            document.getElementById('logFilter').addEventListener('change', refreshLogs);
            document.addEventListener('input', handleNameEdit);
            
            // 设置默认日期范围
            setupDefaultDates();
            
            // 刷新日志
            refreshLogs();
        }

        // 更新当前月份显示
        function updateCurrentMonthDisplay() {
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', 
                                '七月', '八月', '九月', '十月', '十一月', '十二月'];
            const monthNum = parseInt(state.activeMonth.split('-')[1]);
            document.getElementById('currentMonthDisplay').textContent = monthNames[monthNum - 1];
        }

        // 设置默认日期范围
        function setupDefaultDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            // 格式化日期为 YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            startDateInput.value = formatDate(firstDay);
            endDateInput.value = formatDate(lastDay);
        }

        // 初始化年份选择器
        function initYearSelector() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            
            // 清空现有选项
            yearSelect.innerHTML = '';
            
            // 添加最近5年的选项
            for (let year = currentYear - 2; year <= currentYear + 3; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + '年';
                if (year === state.year) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // 处理年份变更
        function changeYear(event) {
            const newYear = parseInt(event.target.value);
            if (state.year !== newYear) {
                state.year = newYear;
                localStorage.setItem('year', newYear.toString());
                generateMonthTabs();
                renderAllTables();
                // 激活该年1月
                activateTab(`${state.year}-01`);
                addLog(`年份切换为 ${newYear}`);
            }
        }

        // 生成月份标签
        function generateMonthTabs() {
            const monthTabs = document.getElementById('monthTabs');
            monthTabs.innerHTML = '';
            
            const currentYear = new Date().getFullYear();
            const months = [
                '一月', '二月', '三月', '四月', '五月', '六月',
                '七月', '八月', '九月', '十月', '十一月', '十二月'
            ];
            
            // 在移动端只显示当前月份的前后各2个月
            if (window.innerWidth <= 768) {
                const currentMonth = new Date().getMonth();
                const startMonth = Math.max(0, currentMonth - 2);
                const endMonth = Math.min(11, currentMonth + 2);
                
                for (let i = startMonth; i <= endMonth; i++) {
                    const monthKey = `${currentYear}-${(i + 1).toString().padStart(2, '0')}`;
                    const tab = createMonthTab(monthKey, months[i]);
                    monthTabs.appendChild(tab);
                }
            } else {
                // 在桌面端显示当前年份的所有月份
                for (let i = 0; i < 12; i++) {
                    const monthKey = `${currentYear}-${(i + 1).toString().padStart(2, '0')}`;
                    const tab = createMonthTab(monthKey, months[i]);
                    monthTabs.appendChild(tab);
                }
            }
            
            // 激活当前月份标签
            const today = new Date();
            const currentMonthKey = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            activateTab(currentMonthKey);
        }

        // 创建月份标签
        function createMonthTab(monthKey, monthName) {
            const tab = document.createElement('div');
            tab.className = 'tab-button';
            tab.setAttribute('data-month', monthKey);
            tab.innerHTML = `
                <i class="fas fa-calendar-alt"></i>
                <span>${monthName}</span>
            `;
            tab.onclick = () => activateTab(monthKey);
            return tab;
        }

        // 监听窗口大小变化
        window.addEventListener('resize', () => {
            generateMonthTabs();
        });

        function activateTab(monthKey) {
            state.activeMonth = monthKey;
            localStorage.setItem('activeMonth', monthKey);
            
            // 更新活跃状态
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.month === monthKey);
            });
            
            // 显示对应月份的表格
            document.querySelectorAll('.table-container').forEach(table => {
                table.style.display = table.dataset.month === monthKey ? 'block' : 'none';
            });
            
            // 更新当前月份显示
            updateCurrentMonthDisplay();
        }

        // 渲染所有月份的表格
        function renderAllTables() {
            const tablesContainer = document.getElementById('tablesContainer');
            tablesContainer.innerHTML = '';
            
            for (let month = 1; month <= 12; month++) {
                const monthName = month < 10 ? `0${month}` : month;
                const monthKey = `${state.year}-${monthName}`;
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'table-container';
                tableContainer.dataset.month = monthKey;
                tableContainer.style.display = monthKey === state.activeMonth ? 'block' : 'none';
                
                const table = createMonthTable(month);
                tableContainer.appendChild(table);
                
                tablesContainer.appendChild(tableContainer);
            }
        }

        // 创建月份表格
        function createMonthTable(month) {
            // 获取该月份的第一天和最后一天
            const firstDay = new Date(state.year, month - 1, 1);
            const lastDay = new Date(state.year, month, 0);
            
            // 创建表格
            const table = document.createElement('table');
            table.className = 'dense-table';
            
            // 创建表头（星期行）
            const headerRow = document.createElement('tr');
            
            // 添加员工名字列头
            const nameHeader = document.createElement('th');
            nameHeader.className = 'fixed-column';
            nameHeader.textContent = '员工';
            headerRow.appendChild(nameHeader);
            
            // 添加日期列
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(state.year, month - 1, day);
                
                const th = document.createElement('th');
                th.className = 'date-header';
                th.textContent = `${day}`;
                
                // 标记为今天
                const today = new Date();
                if (today.getFullYear() === state.year && 
                    today.getMonth() + 1 === month && 
                    today.getDate() === day) {
                    th.classList.add('current-day');
                }
                
                th.innerHTML += `<div>${getWeekday(date)}</div>`;
                headerRow.appendChild(th);
            }
            
            table.appendChild(headerRow);
            
            // 为每个员工创建一行
            state.staff.forEach((staff, staffIndex) => {
                const row = document.createElement('tr');
                
                // 员工名字列
                const nameCell = document.createElement('td');
                nameCell.className = 'fixed-column';
                
                const nameContainer = document.createElement('div');
                nameContainer.className = 'name-container';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'editable-name';
                nameSpan.textContent = staff;
                nameSpan.dataset.original = staff;
                nameSpan.contentEditable = true;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-staff-btn';
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.title = "删除员工";
                deleteBtn.addEventListener('click', () => deleteStaff(staffIndex));
                
                nameContainer.appendChild(nameSpan);
                // 防止删除自己的按钮
                if (staffIndex > 0) {
                    nameContainer.appendChild(deleteBtn);
                }
                
                nameCell.appendChild(nameContainer);
                row.appendChild(nameCell);
                
                // 为每一天创建单元格
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dateStr = `${state.year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    
                    // 初始化状态（工作日）
                    let status = '班';
                    
                    // 检查是否已存在排班数据
                    if (state.schedule[staff] && state.schedule[staff][dateStr]) {
                        status = state.schedule[staff][dateStr];
                    }
                    
                    const cell = createStatusCell(dateStr, staff, status);
                    row.appendChild(cell);
                }
                
                table.appendChild(row);
            });
            
            // 添加新员工行

            
            return table;
        }

        // 创建状态单元格
        function createStatusCell(date, staff, status) {
            const cell = document.createElement('td');
            cell.className = 'status-cell';
            cell.dataset.date = date;
            cell.dataset.staff = staff;
            
            const dot = document.createElement('div');
            dot.className = `status-dot ${status}`;
            dot.textContent = status;
            dot.onclick = () => toggleStatus(cell);
            
            cell.appendChild(dot);
            return cell;
        }

        // 切换状态
        function toggleStatus(cell) {
            const staff = cell.dataset.staff;
            const date = cell.dataset.date;
            const currentStatus = cell.querySelector('.status-dot').textContent;
            
            const statusMap = {
                '班': '值',
                '值': '休',
                '休': '假',
                '假': '班'
            };
            
            const newStatus = statusMap[currentStatus];
            const dot = cell.querySelector('.status-dot');
            dot.textContent = newStatus;
            dot.className = `status-dot ${newStatus}`;
            
            // 保存到状态管理
            if (!state.schedule[staff]) {
                state.schedule[staff] = {};
            }
            state.schedule[staff][date] = newStatus;
            
            // 保存到localStorage
            localStorage.setItem('schedule', JSON.stringify(state.schedule));
            
            // 记录日志
            addLog(`员工 ${staff} ${date} 状态由 ${currentStatus} 改为 ${newStatus}`);
        }

        // 添加日志
        function addLog(message) {
            const now = new Date();
            const time = now.toLocaleTimeString();
            
            state.logs.unshift({
                time: time,
                message: message
            });
            
            // 仅保留最近的50条日志
            if (state.logs.length > 50) {
                state.logs.pop();
            }
            
            localStorage.setItem('logs', JSON.stringify(state.logs));
            refreshLogs();
        }

        // 刷新日志显示
        function refreshLogs() {
            const logContainer = document.getElementById('logEntries');
            const filterType = document.getElementById('logFilter').value;
            logContainer.innerHTML = '';
            
            const filteredLogs = state.logs.filter(log => {
                if (filterType === 'all') return true;
                if (filterType === '→ 休') return log.message.includes('→ 休');
                if (filterType === '→ 假') return log.message.includes('→ 假');
                if (filterType === '删除人员') return log.message.includes('删除');
                return false;
            });
            
            filteredLogs.forEach(log => {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                
                const timeSpan = document.createElement('div');
                timeSpan.className = 'log-time';
                timeSpan.textContent = log.time;
                
                const messageSpan = document.createElement('div');
                messageSpan.className = 'log-message';
                messageSpan.textContent = log.message;
                
                if (log.message.includes('删除')) {
                    messageSpan.classList.add('highlight');
                }
                
                entry.appendChild(timeSpan);
                entry.appendChild(messageSpan);
                logContainer.appendChild(entry);
            });
        }

        // 处理名字编辑
        function handleNameEdit(event) {
            if (event.target.classList.contains('editable-name')) {
                const original = event.target.dataset.original;
                const newName = event.target.textContent.trim();
                
                if (newName && newName !== original) {
                    const index = state.staff.indexOf(original);
                    if (index !== -1) {
                        // 更新状态管理
                        state.staff[index] = newName;
                        
                        // 保存到localStorage
                        localStorage.setItem('staff', JSON.stringify(state.staff));
                        
                        // 更新日志
                        addLog(`员工更名：${original} → ${newName}`);
                        
                        // 重置原始记录
                        event.target.dataset.original = newName;
                    }
                }
            }
        }

        function addStaff() {
            const newStaffName = prompt('请输入新员工的姓名：');
            if (newStaffName && newStaffName.trim() !== '') {
                const trimmedName = newStaffName.trim();
                state.staff.push(trimmedName);
                
                // 保存到localStorage
                localStorage.setItem('staff', JSON.stringify(state.staff));
                
                // 重新渲染表格
                renderAllTables();
                activateTab(state.activeMonth);
                
                // 添加日志
                addLog(`添加新员工：${trimmedName}`);
            }
        }
        // 删除员工
        function deleteStaff(staffIndex) {
            const staffName = state.staff[staffIndex];
            if (confirm(`确定要删除员工 ${staffName} 吗？`)) {
                state.staff.splice(staffIndex, 1);
                
                // 保存到localStorage
                localStorage.setItem('staff', JSON.stringify(state.staff));
                
                // 重新渲染表格
                renderAllTables();
                activateTab(state.activeMonth);
                
                // 添加日志
                addLog(`删除员工：${staffName}`);
            }
        }

        // 重置排班
        function resetSchedule() {
            if (confirm('确定要重置所有排班记录吗？')) {
                state.schedule = {};
                localStorage.setItem('schedule', JSON.stringify(state.schedule));
                
                // 重新渲染表格
                renderAllTables();
                activateTab(state.activeMonth);
                
                // 添加日志
                addLog('所有排班已重置');
            }
        }
        function clearLogs() {
            if (confirm('确定要清除所有操作记录吗？')) {
                state.logs = [];
                localStorage.setItem('logs', JSON.stringify(state.logs));
                refreshLogs();
                
                // 添加一条初始日志
                state.logs.push({
                    time: new Date().toLocaleTimeString(), 
                    message: "操作记录已清空"
                });
                refreshLogs();
            }
        }


        // 获取星期几
        function getWeekday(date) {
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            return weekdays[date.getDay()];
        }
        // 查看排班功能
        function toggleCustomSchedule() {
            const popup = document.getElementById('schedulePopup');
            popup.classList.toggle('active');
            
            if (popup.classList.contains('active')) {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    alert('请选择日期范围');
                    popup.classList.remove('active');
                    return;
                }
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                const dateRange = [];
                let d = new Date(start);
                
                while (d <= end) {
                    dateRange.push(new Date(d));
                    d.setDate(d.getDate() + 1);
                }
                
                const popupBody = document.getElementById('schedulePopupBody');
                popupBody.innerHTML = '';
                
                const table = document.createElement('table');
                table.className = 'schedule-table';
                
                // 创建表头
                const headerRow = document.createElement('tr');
                const nameHeader = document.createElement('th');
                nameHeader.className = 'fixed-column';
                nameHeader.textContent = '员工';
                headerRow.appendChild(nameHeader);
                
                dateRange.forEach(date => {
                    const th = document.createElement('th');
                    th.textContent = `${date.getMonth() + 1}/${date.getDate()}`;
                    th.innerHTML += `<div>${getWeekday(date)}</div>`;
                    headerRow.appendChild(th);
                });
                
                table.appendChild(headerRow);
                
                // 创建员工行
                state.staff.forEach(staff => {
                    const row = document.createElement('tr');
                    
                    const nameCell = document.createElement('td');
                    nameCell.className = 'fixed-column';
                    nameCell.textContent = staff;
                    row.appendChild(nameCell);
                    
                    dateRange.forEach(date => {
                        const dateStr = formatDate(date);
                        const statusCell = document.createElement('td');
                        statusCell.className = 'status-cell';
                        
                        let status = '班';
                        if (state.schedule[staff] && state.schedule[staff][dateStr]) {
                            status = state.schedule[staff][dateStr];
                        }
                        
                        const dot = document.createElement('div');
                        dot.className = `status-dot ${status}`;
                        dot.textContent = status;
                        statusCell.appendChild(dot);
                        
                        row.appendChild(statusCell);
                    });
                    
                    table.appendChild(row);
                });
                
                popupBody.appendChild(table);
            }
        }

        function goToToday() {
            const today = new Date();
            const currentMonthKey = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            
            // 激活当前月份标签
            activateTab(currentMonthKey);
            
            // 滚动到当前日期
            setTimeout(() => {
                const todayCell = document.querySelector(`.current-day`);
                if (todayCell) {
                    todayCell.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest', 
                        inline: 'center' 
                    });
                }
            }, 300);
            
            // 添加日志
            addLog(`已返回今日`);
        }
        function isMobile() {
            return window.innerWidth <= 768;
        }
        // 格式化日期为 YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        // 页面加载完成后初始化系统
        document.addEventListener('DOMContentLoaded', function() {
            initSystem();
            setTimeout(() => {
                goToToday();
            }, 350);
        });

        // 上二休一自动排班，休息岔开
        function autoArrange231() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (!startDate || !endDate) {
                alert('请选择日期范围');
                return;
            }
            const staffList = state.staff;
            if (staffList.length === 0) {
                alert('请先添加员工');
                return;
            }
            // 生成日期数组
            const start = new Date(startDate);
            const end = new Date(endDate);
            const dateArr = [];
            let d = new Date(start);
            while (d <= end) {
                dateArr.push(new Date(d));
                d.setDate(d.getDate() + 1);
            }
            // 每人休息岔开，严格上二休一
            staffList.forEach((staff, idx) => {
                if (!state.schedule[staff]) state.schedule[staff] = {};
            });
            for (let i = 0; i < dateArr.length; i++) {
                for (let j = 0; j < staffList.length; j++) {
                    const staff = staffList[j];
                    // 以员工序号错开休息日
                    const cycleDay = (i + staffList.length - j) % 3;
                    let status = '班';
                    if (cycleDay === 2) status = '休';
                    const dateStr = formatDate(dateArr[i]);
                    state.schedule[staff][dateStr] = status;
                }
            }
            localStorage.setItem('schedule', JSON.stringify(state.schedule));
            renderAllTables();
            activateTab(state.activeMonth);
            addLog('已自动生成上二休一排班');
            setTimeout(() => {
                goToToday();
            }, 200);
        }

        // 刷新所有内容
        function refreshAll() {
            // 刷新排班表格
            renderAllTables();
            
            // 刷新日志
            refreshLogs();
            
            // 添加刷新动画
            const refreshBtn = document.querySelector('.refresh-btn i');
            refreshBtn.style.animation = 'spin 1s linear';
            setTimeout(() => {
                refreshBtn.style.animation = '';
            }, 1000);
            
            // 添加日志
            addLog('手动刷新系统');
        }

        // 添加刷新动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
