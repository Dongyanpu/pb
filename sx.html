<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排班管理系统</title>
    <style>
        :root {
            --primary: #3b82f6;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 12px;
        }

        /* 新增删除按钮样式 */
        .delete-staff-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-left: 8px;
            font-size: 12px;
        }

        .delete-staff-btn:hover {
            opacity: 0.9;
        }

        .name-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* 原有其他样式保持不变... */
        .month-tabs {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding: 8px 0;
        }

        .tab-button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: var(--primary);
            color: white;
        }

        .table-container {
            margin-top: 12px;
            overflow-x: auto;
        }

        .dense-table {
            border-collapse: collapse;
            font-size: 14px;
            min-width: max-content;
        }

        .fixed-column {
            position: sticky;
            left: 0;
            background: white;
            z-index: 2;
            box-shadow: 2px 0 3px rgba(0,0,0,0.1);
            min-width: 40px;
            padding: 8px;
        }

        .date-header {
            min-width: 40px;
            padding: 8px;
            background: #f8f9fa;
            border: 1px solid #eee;
            text-align: center;
        }

        .status-cell {
            min-width: 10px;
            padding: 10px;
            border: 1px solid #eee;
            cursor: pointer;
            text-align: left;
        }

        .status-dot {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .work { background: #f0f0f0; color: #2e7d32; }
        .rest { background: var(--primary); color: white; }
        .leave { background: #fff8e1; color: #f9a825; }

        .log-panel {
            margin-top: 20px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .log-entry {
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .log-header {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .log-filter {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            flex-shrink: 0;
        }

        .danger-btn {
            padding: 6px 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .danger-btn:hover {
            opacity: 0.9;
        }

        .editable-name {
            outline: none;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .editable-name:focus {
            background: #e2e8f0;
        }

        .export-panel {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .add-staff-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-left: 8px;
        }

        .add-staff-btn:hover {
            opacity: 0.9;
        }
.alert-banner {
    position: fixed;
    top: 60px;
    left: 800px;
    background: var(--warning);
    color: white;
    padding: 16px 32px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 999;
}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>

    <h2>2025年绍兴售后排班管理</h2>
    <div class="alert-banner">
        <span>⚠️</span>
        <span>请勿擅自修改排班信息！</span>
    </div>
    
    <div class="export-panel">
        <input type="date" id="startDate" class="log-filter" value="2025-05-01">
        <span>至</span>
        <!-- ... 其余原有代码保持不变 ... -->
        <input type="date" id="endDate" class="log-filter" value="2025-05-31">
        <button class="danger-btn" onclick="exportPDF()" style="background: var(--primary)">导出PDF</button>
        <button class="danger-btn" onclick="exportExcel()" style="background: var(--warning)">导出Excel</button>
    </div>

    <div class="month-tabs" id="monthTabs"></div>
    <div id="tablesContainer"></div>
    
    <div class="log-panel">
        <div class="log-header">
            <h3>操作记录</h3>
            <select id="logFilter" class="log-filter">
                <option value="all">全部记录</option>
                <option value="→ rest">休息变更</option>
                <option value="→ leave">休假变更</option>
                <option value="删除人员">删除记录</option>
            </select>
            <button class="danger-btn" onclick="resetSchedule()">重置排班</button>
            <button class="danger-btn" onclick="clearLogs()">清除记录</button>
        </div>
        <div id="logEntries"></div>
    </div>

<script>
const state = {
    staff: JSON.parse(localStorage.getItem('staff')) || ['董彦普', '张昭', '孙新'],
    schedule: JSON.parse(localStorage.getItem('schedule')) || {},
    logs: JSON.parse(localStorage.getItem('logs')) || [],
    activeMonth: localStorage.getItem('activeMonth') || '2025-05'
};

function initSystem() {
    generateMonthTabs();
    renderAllTables();
    activateTab(state.activeMonth);
    refreshLogs();
    
    document.getElementById('logFilter').addEventListener('change', () => refreshLogs());
    document.addEventListener('input', handleNameEdit);
}

function handleNameEdit(e) {
    if (e.target.classList.contains('editable-name')) {
        const staffIndex = e.target.getAttribute('data-staff-index');
        const newName = e.target.textContent.trim();
        if (newName) {
            state.staff[staffIndex] = newName;
            localStorage.setItem('staff', JSON.stringify(state.staff));
        }
    }
}

function generateMonthTabs() {
    const months = [];
    for (let m = 4; m <= 11; m++) {
        const monthStr = `2025-${String(m+1).padStart(2, '0')}`;
        months.push(`
            <button class="tab-button" 
                    data-month="${monthStr}"
                    onclick="activateTab('${monthStr}')">
                ${new Date(2025, m).toLocaleDateString('zh-CN', { month: 'long' })}
            </button>
        `);
    }
    document.getElementById('monthTabs').innerHTML = months.join('');
}

function activateTab(month) {
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.month === month);
    });
    
    document.querySelectorAll('.month-table').forEach(table => {
        table.style.display = table.dataset.month === month ? 'block' : 'none';
    });
    
    state.activeMonth = month;
    localStorage.setItem('activeMonth', month);
}

function renderAllTables() {
    const container = document.getElementById('tablesContainer');
    let tablesHTML = '';
    
    for (let m = 4; m <= 11; m++) {
        const monthStr = `2025-${String(m+1).padStart(2, '0')}`;
        tablesHTML += `
            <div class="table-container month-table" 
                 data-month="${monthStr}" 
                 style="display: none">
                ${generateMonthTable(m)}
            </div>`;
    }
    
    container.innerHTML = tablesHTML;
}

function generateMonthTable(month) {
    const start = new Date(Date.UTC(2025, month, 1));
    const end = new Date(Date.UTC(2025, month + 1, 0));
    
    let html = `<table class="dense-table"><thead><tr><th class="fixed-column">人员</th>`;
    
    for (let d = new Date(start); d <= end; d.setUTCDate(d.getUTCDate() + 1)) {
        html += `<th class="date-header">
            <div>${d.getUTCDate()}</div>
            <div style="font-size:12px;color:#666">周${'日一二三四五六'[d.getUTCDay()]}</div>
        </th>`;
    }
    
    html += `</tr></thead><tbody>`;
    
    state.staff.forEach((person, staffIndex) => {
        html += `
        <tr><td class="fixed-column">
            <div class="name-container">
                <span class="editable-name" 
                      contenteditable="true" 
                      data-staff-index="${staffIndex}">${person}</span>
                <button class="delete-staff-btn" onclick="deleteStaff(${staffIndex})">×</button>
            </div>
        </td>`;
        for (let d = new Date(start); d <= end; d.setUTCDate(d.getUTCDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            const status = getCurrentStatus(dateStr, staffIndex);
            html += `
            <td class="status-cell" 
                data-date="${dateStr}"
                data-staff="${staffIndex}"
                onclick="handleStatusClick('${dateStr}', ${staffIndex})">
                <div class="status-dot ${status}">${getStatusText(status)}</div>
            </td>`;
        }
        html += `</tr>`;
    });

    html += `
    <tr>
        <td class="fixed-column">
            <button class="add-staff-btn" onclick="addStaff()">＋ 添加人员</button>
        </td>
        ${'<td></td>'.repeat((end - start)/86400000 + 1)}
    </tr>`;

    return html + `</tbody></table>`;
}

function deleteStaff(staffIndex) {
    if (!confirm(`确定要删除人员 "${state.staff[staffIndex]}" 吗？此操作不可恢复！`)) return;
    
    // 清理相关排班数据
    Object.keys(state.schedule).forEach(date => {
        if (state.schedule[date][staffIndex]) {
            delete state.schedule[date][staffIndex];
            if (Object.keys(state.schedule[date]).length === 0) {
                delete state.schedule[date];
            }
        }
    });
    
    // 记录操作日志
    addLogEntry({
        timestamp: new Date().toLocaleString(),
        action: `删除人员：${state.staff[staffIndex]}`
    });
    
    state.staff.splice(staffIndex, 1);
    saveState();
    renderAllTables();
    activateTab(state.activeMonth);
}

function addStaff() {
    const newName = prompt('请输入新人员姓名：', '新人员');
    if (!newName) return;
    
    const trimmedName = newName.trim();
    if (!trimmedName) {
        alert('姓名不能为空');
        return;
    }
    
    if (state.staff.includes(trimmedName)) {
        alert('该人员已存在');
        return;
    }
    
    state.staff.push(trimmedName);
    saveState();
    renderAllTables();
    activateTab(state.activeMonth);
}

function getCurrentStatus(dateStr, staffIndex) {
    if (state.schedule[dateStr]?.[staffIndex]) {
        return state.schedule[dateStr][staffIndex];
    }
    const baseDay = Math.floor((new Date(dateStr) - new Date('2025-05-16')) / 86400000);
    return (baseDay - staffIndex) % 3 === 2 ? 'rest' : 'work';
}

function handleStatusClick(dateStr, staffIndex) {
    const currentStatus = getCurrentStatus(dateStr, staffIndex);
    const newStatus = getNextStatus(currentStatus);
    const oldStatus = currentStatus;
    
    if (!state.schedule[dateStr]) state.schedule[dateStr] = {};
    state.schedule[dateStr][staffIndex] = newStatus !== 'work' ? newStatus : undefined;
    
    if (state.schedule[dateStr][staffIndex] === undefined) {
        delete state.schedule[dateStr][staffIndex];
        if (Object.keys(state.schedule[dateStr]).length === 0) {
            delete state.schedule[dateStr];
        }
    }
    
    updateStatusCell(dateStr, staffIndex);
    addLogEntry({
        timestamp: new Date().toLocaleString(),
        action: `${state.staff[staffIndex]} ${dateStr} 状态变更：${oldStatus} → ${newStatus}`
    });
    
    saveState();
}

function getNextStatus(current) {
    const statusOrder = ['work', 'rest', 'leave'];
    return statusOrder[(statusOrder.indexOf(current) + 1) % 3];
}

function getStatusText(status) {
    return { work: '班', rest: '休', leave: '假' }[status];
}

function updateStatusCell(dateStr, staffIndex) {
    document.querySelectorAll(`[data-date="${dateStr}"][data-staff="${staffIndex}"] .status-dot`)
        .forEach(cell => {
            const status = getCurrentStatus(dateStr, staffIndex);
            cell.className = `status-dot ${status}`;
            cell.textContent = getStatusText(status);
        });
}

function addLogEntry(logEntry) {
    state.logs.unshift(logEntry);
    if (state.logs.length > 100) state.logs.pop();
    refreshLogs();
}

function refreshLogs() {
    const filter = document.getElementById('logFilter').value;
    const filtered = filter === 'all' ? 
        state.logs : 
        state.logs.filter(log => {
            if (filter === '→ rest') return log.action.includes('→ rest');
            if (filter === '→ leave') return log.action.includes('→ leave');
            if (filter === '删除人员') return log.action.startsWith('删除人员');
            return true;
        });
    
    document.getElementById('logEntries').innerHTML = filtered
        .map(log => `<div class="log-entry">[${log.timestamp}] ${log.action}</div>`)
        .join('');
}

function clearLogs() {
    if (confirm('确定要清除所有操作记录吗？')) {
        state.logs = [];
        saveState();
        refreshLogs();
    }
}

function resetSchedule() {
    if (confirm('确定要重置所有排班数据吗？此操作不可恢复！')) {
        state.schedule = {};
        localStorage.removeItem('schedule');
        renderAllTables();
        activateTab(state.activeMonth);
        saveState();
    }
}

async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.setFont('STSong-Light');

    const start = new Date(document.getElementById('startDate').value);
    const end = new Date(document.getElementById('endDate').value);
    
    const data = state.staff.map(staff => {
        const row = { name: staff };
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            const staffIndex = state.staff.indexOf(staff);
            row[dateStr] = getStatusText(getCurrentStatus(dateStr, staffIndex));
        }
        return row;
    });

    const headers = ['姓名', ...Array.from({length: (end - start)/86400000 + 1}, (_,i) => {
        const d = new Date(start.getTime() + i*86400000);
        return `${d.getMonth()+1}/${d.getDate()}`;
    })];

    const rows = data.map(row => [
        row.name,
        ...Array.from({length: (end - start)/86400000 + 1}, (_,i) => {
            const d = new Date(start.getTime() + i*86400000);
            return row[d.toISOString().split('T')[0]];
        })
    ]);

    pdf.autoTable({
        head: [headers],
        body: rows,
        theme: 'grid',
        styles: { 
            font: 'STSong-Light',
            fontSize: 10
        },
        headerStyles: { 
            fillColor: [59, 130, 246],
            font: 'STSong-Light'
        },
        bodyStyles: {
            font: 'STSong-Light'
        },
        columnStyles: { 
            0: { cellWidth: 20 } 
        }
    });

    pdf.save(`排班表_${start.toISOString().slice(0,10)}_${end.toISOString().slice(0,10)}.pdf`);
}

function exportExcel() {
    const start = new Date(document.getElementById('startDate').value);
    const end = new Date(document.getElementById('endDate').value);
    
    const data = [];
    const header = ['姓名'];
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        header.push(dateStr);
    }
    data.push(header);
    
    state.staff.forEach((staff, index) => {
        const row = [staff];
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            const status = getStatusText(getCurrentStatus(dateStr, index));
            row.push(status);
        }
        data.push(row);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "排班表");
    XLSX.writeFile(wb, `排班表_${start.toISOString().split('T')[0]}_${end.toISOString().split('T')[0]}.xlsx`);
}

function saveState() {
    localStorage.setItem('staff', JSON.stringify(state.staff));
    localStorage.setItem('schedule', JSON.stringify(state.schedule));
    localStorage.setItem('logs', JSON.stringify(state.logs));
}

window.addEventListener('load', initSystem);
</script>
</body>
</html>